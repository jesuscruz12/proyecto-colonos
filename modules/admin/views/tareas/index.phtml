<?php
/**
 * TAKTIK — Tareas (Vista) — PROD
 * - AdminLTE/Bootstrap + DataTables + Buttons
 * - Alertify (mismo look que otras vistas)
 * - Tooltips + Autocomplete para evitar IDs inválidos
 */
?>

<main class="app-main">
  <div class="app-content-header border-bottom pb-2">
    <div class="container-fluid">
      <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
        <div>
          <h3 class="mb-0">
            <i class="bi bi-list-check text-primary"></i> Tareas
          </h3>
          <div class="text-muted small">Planeación y control operativo por OT / proceso / máquina.</div>
        </div>
        <div class="d-flex gap-2">
          <button class="btn btn-primary" id="btn_nueva">
            <i class="bi bi-plus-lg"></i> Nueva tarea
          </button>
          <button class="btn btn-outline-secondary" id="btn_reset">
            <i class="bi bi-arrow-counterclockwise"></i> Limpiar filtros
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="app-content pt-3">
    <div class="container-fluid">

      <!-- Filtros -->
      <div class="card shadow-sm border-0 mb-3">
        <div class="card-header bg-white">
          <div class="d-flex align-items-center gap-2">
            <i class="bi bi-funnel"></i>
            <b>Filtros</b>
            <span class="text-muted small">Afectan búsqueda y exportación.</span>
          </div>
        </div>
        <div class="card-body">
          <div class="row g-2">
            <div class="col-12 col-md-3">
              <label class="form-label small text-muted mb-1">Estado tarea</label>
              <select class="form-select form-select-sm" id="f_estado"></select>
            </div>
            <div class="col-12 col-md-3">
              <label class="form-label small text-muted mb-1">Proceso</label>
              <select class="form-select form-select-sm" id="f_proceso"></select>
            </div>
            <div class="col-12 col-md-3">
              <label class="form-label small text-muted mb-1">Máquina</label>
              <select class="form-select form-select-sm" id="f_maquina"></select>
            </div>
            <div class="col-12 col-md-3">
              <label class="form-label small text-muted mb-1">Estado OT</label>
              <select class="form-select form-select-sm" id="f_ot_estado">
                <option value="">Todos</option>
                <option value="pendiente">Pendiente</option>
                <option value="planificada">Planificada</option>
                <option value="en_proceso">En proceso</option>
                <option value="en_cuarentena">En cuarentena</option>
                <option value="cerrada">Cerrada</option>
                <option value="cancelada">Cancelada</option>
              </select>
            </div>

            <div class="col-12 col-md-3">
              <label class="form-label small text-muted mb-1">Desde (inicio planeado)</label>
              <input type="date" class="form-control form-control-sm" id="f_desde">
            </div>
            <div class="col-12 col-md-3">
              <label class="form-label small text-muted mb-1">Hasta (inicio planeado)</label>
              <input type="date" class="form-control form-control-sm" id="f_hasta">
            </div>
            <div class="col-12 col-md-6 d-flex align-items-end justify-content-end">
              <div class="text-muted small">
                Tip: usa <b>Column visibility</b> para exportar solo lo necesario.
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Tabla -->
      <div class="card shadow-sm border-0">
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-sm align-middle w-100" id="tbl_tareas">
              <thead>
                <tr>
                  <th>#</th>
                  <th>OT</th>
                  <th>Cliente</th>
                  <th>Proceso</th>
                  <th>Sec</th>
                  <th>Cant</th>
                  <th>Máquina</th>
                  <th>Inicio plan</th>
                  <th>Fin plan</th>
                  <th>Estado</th>
                  <th>Duración</th>
                  <th>Creado</th>
                  <th></th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>

          <div class="small text-muted mt-2">
            Si una tarea está <b>bloqueada_calidad</b>, el motivo debe existir.
          </div>
        </div>
      </div>

    </div>
  </div>
</main>

<!-- Modal: Crear/Editar -->
<div class="modal fade" id="mdl_tarea" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <div>
          <h5 class="modal-title mb-0" id="mdl_title">Tarea</h5>
          <div class="text-muted small" id="mdl_subtitle"></div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>

      <div class="modal-body">
        <div class="alert alert-info py-2 mb-3" id="mdl_alert">Completa los datos.</div>

        <form id="frm_tarea" autocomplete="off">
          <input type="hidden" id="t_id">

          <div class="row g-2">

            <!-- OT Autocomplete -->
            <div class="col-12 col-md-6 position-relative">
              <label class="form-label small text-muted mb-1">
                OT
                <i class="bi bi-info-circle ms-1 text-secondary"
                   data-bs-toggle="tooltip"
                   title="Busca por folio/cliente/dibujo. Selecciona una OT válida."></i>
              </label>

              <input type="hidden" id="t_ot_id">
              <input class="form-control form-control-sm" id="t_ot_q" placeholder="Ej: OT-0001 / cliente / dibujo...">
              <div id="ot_suggest" class="list-group position-absolute w-100 d-none"
                   style="z-index: 1080; max-height: 260px; overflow:auto;"></div>
              <div class="form-text">Escribe mínimo 2 letras.</div>
            </div>

            <div class="col-12 col-md-6">
              <label class="form-label small text-muted mb-1">
                Proceso
                <i class="bi bi-info-circle ms-1 text-secondary"
                   data-bs-toggle="tooltip"
                   title="El proceso define la operación. Si tiene setup sugerido, se puede precargar."></i>
              </label>
              <select class="form-select form-select-sm" id="t_proceso"></select>
            </div>

            <div class="col-12 col-md-4">
              <label class="form-label small text-muted mb-1">Estado</label>
              <select class="form-select form-select-sm" id="t_estado"></select>
            </div>

            <div class="col-6 col-md-2">
              <label class="form-label small text-muted mb-1">Secuencia</label>
              <input class="form-control form-control-sm" id="t_secuencia" type="number" min="1" value="1">
            </div>

            <div class="col-6 col-md-3">
              <label class="form-label small text-muted mb-1">Cantidad</label>
              <input class="form-control form-control-sm" id="t_cantidad" type="number" step="0.0001" min="0.0001" value="1">
            </div>

            <div class="col-12 col-md-3">
              <label class="form-label small text-muted mb-1">Máquina</label>
              <select class="form-select form-select-sm" id="t_maquina"></select>
            </div>

            <div class="col-12 col-md-4">
              <label class="form-label small text-muted mb-1">
                Tipo origen
                <i class="bi bi-info-circle ms-1 text-secondary"
                   data-bs-toggle="tooltip"
                   title="Define qué catálogo usar: parte / subensamble / kit_expandido (producto)."></i>
              </label>
              <select class="form-select form-select-sm" id="t_tipo_origen">
                <option value="parte">parte</option>
                <option value="subensamble">subensamble</option>
                <option value="kit_expandido">kit_expandido</option>
              </select>
            </div>

            <div class="col-6 col-md-4">
              <label class="form-label small text-muted mb-1">Inicio planeado</label>
              <input class="form-control form-control-sm" id="t_ini_plan" type="datetime-local">
            </div>
            <div class="col-6 col-md-4">
              <label class="form-label small text-muted mb-1">Fin planeado</label>
              <input class="form-control form-control-sm" id="t_fin_plan" type="datetime-local">
            </div>

            <div class="col-4 col-md-2">
              <label class="form-label small text-muted mb-1">Setup (min)</label>
              <input class="form-control form-control-sm" id="t_setup" type="number" min="0" value="0">
            </div>
            <div class="col-4 col-md-2">
              <label class="form-label small text-muted mb-1">Seg/Unidad</label>
              <input class="form-control form-control-sm" id="t_segu" type="number" min="0" value="0">
            </div>
            <div class="col-4 col-md-2">
              <label class="form-label small text-muted mb-1">Duración (min)</label>
              <input class="form-control form-control-sm" id="t_dur" type="number" min="0" value="0">
            </div>

            <div class="col-12">
              <label class="form-label small text-muted mb-1">
                Motivo bloqueo (si aplica)
                <i class="bi bi-info-circle ms-1 text-secondary"
                   data-bs-toggle="tooltip"
                   title="Solo requerido si estado = bloqueada_calidad."></i>
              </label>
              <input class="form-control form-control-sm" id="t_motivo" maxlength="255" placeholder="Requerido si bloqueada_calidad">
            </div>

            <div class="col-12">
              <button class="btn btn-outline-secondary btn-sm mt-2" type="button"
                      data-bs-toggle="collapse" data-bs-target="#adv_box" aria-expanded="false">
                <i class="bi bi-sliders"></i> Avanzado
              </button>
            </div>

            <!-- Avanzado: Autocomplete -->
            <div class="col-12">
              <div class="collapse mt-2" id="adv_box">
                <div class="card border-0 shadow-sm">
                  <div class="card-body">
                    <div class="text-muted small mb-2">
                      Aquí NO metes “IDs a ciegas”. Usa búsqueda y selecciona.
                    </div>

                    <!-- Item de OT -->
                    <div class="row g-2">
                      <div class="col-12 col-md-6 position-relative">
                        <label class="form-label small text-muted mb-1">
                          Item de OT
                          <i class="bi bi-info-circle ms-1 text-secondary"
                             data-bs-toggle="tooltip"
                             title="Depende de la OT seleccionada. Busca por parte/subensamble/producto."></i>
                        </label>
                        <input type="hidden" id="t_item_id">
                        <input class="form-control form-control-sm" id="t_item_q" placeholder="Buscar item...">
                        <div id="item_suggest" class="list-group position-absolute w-100 d-none"
                             style="z-index: 1080; max-height: 260px; overflow:auto;"></div>
                        <div class="form-text">Primero selecciona OT.</div>
                      </div>

                      <!-- Parte -->
                      <div class="col-12 col-md-6 position-relative">
                        <label class="form-label small text-muted mb-1">Parte</label>
                        <input type="hidden" id="t_parte_id">
                        <input class="form-control form-control-sm" id="t_parte_q" placeholder="Buscar parte...">
                        <div id="parte_suggest" class="list-group position-absolute w-100 d-none"
                             style="z-index: 1080; max-height: 260px; overflow:auto;"></div>
                      </div>

                      <!-- Subensamble -->
                      <div class="col-12 col-md-6 position-relative">
                        <label class="form-label small text-muted mb-1">Subensamble</label>
                        <input type="hidden" id="t_sub_id">
                        <input class="form-control form-control-sm" id="t_sub_q" placeholder="Buscar subensamble...">
                        <div id="sub_suggest" class="list-group position-absolute w-100 d-none"
                             style="z-index: 1080; max-height: 260px; overflow:auto;"></div>
                      </div>

                      <!-- Producto -->
                      <div class="col-12 col-md-6 position-relative">
                        <label class="form-label small text-muted mb-1">Producto</label>
                        <input type="hidden" id="t_prod_id">
                        <input class="form-control form-control-sm" id="t_prod_q" placeholder="Buscar producto...">
                        <div id="prod_suggest" class="list-group position-absolute w-100 d-none"
                             style="z-index: 1080; max-height: 260px; overflow:auto;"></div>
                      </div>

                      <div class="col-12">
                        <div class="alert alert-warning py-2 mb-0">
                          Tip: según <b>tipo_origen</b> se habilita solo el campo correcto y se limpian los demás.
                        </div>
                      </div>

                    </div>

                  </div>
                </div>
              </div>
            </div>

          </div>
        </form>
      </div>

      <div class="modal-footer d-flex justify-content-between">
        <button class="btn btn-outline-danger" id="btn_eliminar" type="button">
          <i class="bi bi-trash"></i> Eliminar
        </button>
        <div class="d-flex gap-2">
          <button class="btn btn-outline-secondary" data-bs-dismiss="modal" type="button">
            Cancelar
          </button>
          <button class="btn btn-primary" id="btn_guardar" type="button">
            <i class="bi bi-save"></i> Guardar
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal Confirmación (consistente) -->
<div class="modal fade" id="mdl_confirm" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="mdl_confirm_title">Confirmar acción</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body" id="mdl_confirm_body">¿Confirmas esta acción?</div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-danger" id="mdl_confirm_ok">Confirmar</button>
      </div>
    </div>
  </div>
</div>
