<main class="app-main page-portabilidades">
  <!-- ======= Encabezado ======= -->
  <div class="app-content-header">
    <div class="container-fluid">

      <!-- Título + migas -->
      <div class="row align-items-center">
        <div class="col-sm-6">
          <h3 class="mb-0">Portabilidades</h3>
        </div>
        <div class="col-sm-6">
          <ol class="breadcrumb float-sm-end mb-0">
            <li class="breadcrumb-item"><a href="<?php echo BASE_URL; ?>">Inicio</a></li>
            <li class="breadcrumb-item active" aria-current="page">Portabilidades</li>
          </ol>
        </div>
      </div>

      <!-- Toolbar de fechas para KPIs -->
      <div class="row mt-2">
        <div class="col-12">
          <form id="frm_rango_kpi" class="row g-2 align-items-center justify-content-start justify-content-lg-end">
            <div class="col-auto">
              <div class="input-group">
                <span class="input-group-text"><i class="bi bi-calendar-event"></i></span>
                <input type="date" class="form-control" id="kpi_desde" aria-label="Desde">
              </div>
            </div>
            <div class="col-auto">
              <div class="input-group">
                <span class="input-group-text"><i class="bi bi-calendar-event"></i></span>
                <input type="date" class="form-control" id="kpi_hasta" aria-label="Hasta">
              </div>
            </div>
            <div class="col-auto">
              <button type="button" id="btn_kpi_aplicar" class="btn btn-primary">
                <i class="bi bi-check2-circle me-1"></i> Aplicar
              </button>
            </div>
          </form>
        </div>
      </div>

    </div>
  </div>

  <!-- ======= Contenido ======= -->
  <div class="app-content">
    <div class="container-fluid">

      <!-- KPIs -->
      <div class="row g-3">
        <div class="col-12 col-sm-6 col-xl-3">
          <div class="info-box shadow-sm">
            <span class="info-box-icon bg-primary"><i class="bi bi-list-check"></i></span>
            <div class="info-box-content">
              <span class="info-box-text text-muted">Solicitudes</span>
              <span class="info-box-number fs-5 fw-semibold" id="kpi_total">—</span>
            </div>
          </div>
        </div>
        <div class="col-12 col-sm-6 col-xl-3">
          <div class="info-box shadow-sm">
            <span class="info-box-icon bg-success"><i class="bi bi-check2-circle"></i></span>
            <div class="info-box-content">
              <span class="info-box-text text-muted">Completadas</span>
              <span class="info-box-number fs-5 fw-semibold" id="kpi_ok">—</span>
            </div>
          </div>
        </div>
        <div class="col-12 col-sm-6 col-xl-3">
          <div class="info-box shadow-sm">
            <span class="info-box-icon bg-warning"><i class="bi bi-hourglass-split"></i></span>
            <div class="info-box-content">
              <span class="info-box-text text-muted">En proceso</span>
              <span class="info-box-number fs-5 fw-semibold" id="kpi_proc">—</span>
            </div>
          </div>
        </div>
        <div class="col-12 col-sm-6 col-xl-3">
          <div class="info-box shadow-sm">
            <span class="info-box-icon bg-danger"><i class="bi bi-x-octagon"></i></span>
            <div class="info-box-content">
              <span class="info-box-text text-muted">Rechazadas</span>
              <span class="info-box-number fs-5 fw-semibold" id="kpi_rech">—</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Filtros -->
      <div class="card mt-3">
        <div class="card-header">
          <h3 class="card-title mb-0"><i class="bi bi-funnel me-1"></i> Filtros</h3>
        </div>

        <div class="card-body">
          <form id="frm_filtros" class="row g-3">
            <!-- Número -->
            <div class="col-12 col-lg-3">
              <label for="f_numero" class="form-label">Número a portar</label>
              <div class="input-group">
                <span class="input-group-text"><i class="bi bi-phone"></i></span>
                <input
                  type="text"
                  class="form-control input-numeric"
                  id="f_numero"
                  placeholder="Ej. 5512345678"
                  inputmode="numeric"
                  maxlength="10">
              </div>
              <div class="form-text text-muted">Exactamente 10 dígitos</div>
            </div>

            <!-- Estatus -->
            <div class="col-6 col-lg-2">
              <label for="f_estatus" class="form-label">Estatus</label>
              <select id="f_estatus" class="form-select">
                <option value="">Todos</option>
                <option value="1">Pendiente</option>
                <option value="2">Numlex</option>
                <option value="3">Procesado</option>
                <option value="4">Rechazado</option>
                <option value="5">Estatus 5</option>
                <option value="6">Estatus 6</option>
              </select>
            </div>

            <!-- Desde -->
            <div class="col-6 col-lg-2">
              <label for="f_desde" class="form-label">Desde</label>
              <div class="input-group">
                <span class="input-group-text"><i class="bi bi-calendar-event"></i></span>
                <input type="date" class="form-control" id="f_desde">
              </div>
            </div>

            <!-- Hasta -->
            <div class="col-6 col-lg-2">
              <label for="f_hasta" class="form-label">Hasta</label>
              <div class="input-group">
                <span class="input-group-text"><i class="bi bi-calendar-event"></i></span>
                <input type="date" class="form-control" id="f_hasta">
              </div>
            </div>

            <!-- Botón Buscar -->
            <div class="col-6 col-lg-auto">
              <label class="form-label d-none d-lg-block">&nbsp;</label>
              <button
                type="button"
                id="btn_aplicar_filtros"
                class="btn btn-primary w-100 w-lg-auto"
                data-bs-toggle="tooltip"
                title="Aplicar filtros">
                <i class="bi bi-search me-1"></i> Buscar
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- Listado -->
      <div class="card">
        <div class="card-header d-flex align-items-center">
          <h3 class="card-title mb-0"><i class="bi bi-table me-1"></i> Listado</h3>

          <div class="ms-auto d-flex gap-2">
            <button class="btn btn-outline-secondary btn-sm" id="btn_recargar"
              data-bs-toggle="tooltip" title="Limpiar filtros y recargar datos">
              <i class="bi bi-arrow-repeat"></i>
            </button>

            <?php if (Session::get('rol') == ADMINISTRADOR || (Session::get('permisos')['portabilidades.crear'] ?? false)) : ?>
              <button class="btn btn-primary btn-sm extend-new-recurso" data-bs-toggle="modal" data-bs-target="#modal-crear">
                <i class="bi bi-plus-circle me-1"></i> Solicitar nueva
              </button>
              <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#modal-carga">
                <i class="bi bi-file-earmark-arrow-up me-1"></i> Subir CSV/TXT
              </button>
              <a class="btn btn-outline-secondary btn-sm" href="<?php echo BASE_URL; ?>admin/wlportabilidades/plantilla_csv">
                <i class="bi bi-download me-1"></i> Plantilla CSV
              </a>
            <?php endif; ?>
          </div>
        </div>

        <div class="card-body">
          <div class="table-responsive">
            <table id="recursos-table" class="table table-striped table-bordered w-100 align-middle">
              <thead>
                <tr class="align-middle">
                  <th>Id</th>
                  <th>Fecha solicitud</th>
                  <th>Número</th>
                  <th>ICCID</th>
                  <th>Cliente</th>
                  <th>Correo</th>
                  <th>Estatus</th>
                  <th>Pre</th>
                  <th>Tipo</th>
                  <th style="width:140px;" class="dt-actions">Acciones</th>
                </tr>
              </thead>
              <tbody></tbody>
              <tfoot>
                <tr>
                  <th></th>
                  <th>Fecha solicitud</th>
                  <th>Número</th>
                  <th>ICCID</th>
                  <th>Cliente</th>
                  <th>Correo</th>
                  <th>Estatus</th>
                  <th>Pre</th>
                  <th>Tipo</th>
                  <th></th>
                </tr>
              </tfoot>
            </table>
          </div>
          <div class="small text-muted mt-2">
            Tip: usa la caja “Buscar” o los filtros de arriba. Mantén <kbd>Shift</kbd> para ordenar por múltiples columnas.
          </div>
        </div>
      </div>

    </div>
  </div>
</main>

<!-- ======= Modal: NUEVA ======= -->
<div class="modal fade" id="modal-crear" tabindex="-1" aria-labelledby="crearModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered mx-auto">
    <div class="modal-content border-0 shadow">
      <form id="frm_nuevo" method="post" class="m-0" autocomplete="off">
        <div class="card card-primary card-outline mb-0">
          <div class="card-header">
            <h5 class="card-title mb-0" id="crearModalLabel">
              <i class="bi bi-plus-circle me-1"></i> Nueva solicitud
            </h5>
            <button type="button" class="btn btn-sm btn-outline-secondary float-end" data-bs-dismiss="modal">Cerrar</button>
          </div>

          <div class="card-body">
            <input type="hidden" name="csrf_token" value="<?php echo Session::get('tokencsrf'); ?>">

            <div class="row g-3">
              <div class="col-12 col-md-4">
                <label class="form-label">Número a portar *</label>
                <input type="text" class="form-control input-numeric" name="numero_a_portar"
                  required inputmode="numeric" maxlength="10" minlength="10" placeholder="5512345678">
              </div>

              <div class="col-12 col-md-4">
                <label class="form-label">ICCID *</label>
                <input type="text" class="form-control" name="icc" required maxlength="22" placeholder="ICCID">
              </div>

              <div class="col-12 col-md-4">
                <label class="form-label">NIP *</label>
                <input type="text" class="form-control input-numeric" name="nip"
                  required inputmode="numeric" maxlength="6" minlength="4" placeholder="4–6 dígitos">
              </div>

              <div class="col-12 col-md-6">
                <label class="form-label">Nombre del cliente *</label>
                <input type="text" class="form-control" name="nombre_cliente" required maxlength="200">
              </div>

              <div class="col-12 col-md-6">
                <label class="form-label">Correo del cliente</label>
                <input type="email" class="form-control" name="correo_cliente" placeholder="opcional">
              </div>

              <div class="col-6 col-md-4">
                <label class="form-label">Preportabilidad</label>
                <select class="form-select" name="preportabilidad">
                  <option value="1">Sí</option>
                  <option value="0">No</option>
                </select>
              </div>

              <div class="col-6 col-md-4">
                <label class="form-label">Tipo</label>
                <select class="form-select" name="tipo_portabilidad">
                  <option value="1">Prepago</option>
                  <option value="2">Pospago</option>
                </select>
              </div>

              <div class="col-12 col-md-4">
                <label class="form-label">Origen</label>
                <select class="form-select" name="origen_porta">
                  <option value="1">Web</option>
                  <option value="2">CSV</option>
                  <option value="3">API</option>
                </select>
              </div>
            </div>

            <div class="text-center mt-3">
              <div class="spinner-border text-primary" role="status" style="display:none;">
                <span class="visually-hidden">Procesando...</span>
              </div>
            </div>
          </div>

          <div class="card-footer d-flex justify-content-end gap-2">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="submit" class="btn btn-primary">
              <i class="bi bi-send-check me-1"></i> Enviar solicitud
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- ======= Modal: EDITAR (muestra detalle y permite editar si estatus 1-2) ======= -->
<div class="modal fade" id="modal-editar" tabindex="-1" aria-labelledby="editarModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered mx-auto">
    <div class="modal-content border-0 shadow">
      <form id="frm_editar" method="post" class="m-0" autocomplete="off">
        <div class="card card-warning card-outline mb-0">
          <div class="card-header">
            <h5 class="card-title mb-0" id="editarModalLabel">
              <i class="bi bi-pencil-square me-1"></i> Solicitud
            </h5>
            <button type="button" class="btn btn-sm btn-outline-secondary float-end" data-bs-dismiss="modal">Cerrar</button>
          </div>

          <div class="card-body">
            <input type="hidden" name="csrf_token" value="<?php echo Session::get('tokencsrf'); ?>">
            <input type="hidden" name="cv_portabilidad" id="cv_portabilidad_editar">

            <div id="nota_editar" class="alert alert-warning py-2 small d-none">
              <i class="bi bi-info-circle me-1"></i>
              Al guardar se actualizará la <strong>fecha de solicitud</strong> a la fecha y hora actuales.
            </div>

            <div class="row g-3">
              <div class="col-12 col-md-4">
                <label class="form-label">Número a portar *</label>
                <input type="text" class="form-control input-numeric" name="numero_a_portar" id="numero_editar"
                  required maxlength="10" minlength="10" inputmode="numeric">
              </div>

              <div class="col-12 col-md-4">
                <label class="form-label">ICCID *</label>
                <input type="text" class="form-control" name="icc" id="icc_editar" required maxlength="22">
              </div>

              <div class="col-12 col-md-4">
                <label class="form-label">NIP *</label>
                <input type="text" class="form-control input-numeric" name="nip" id="nip_editar"
                  required maxlength="6" minlength="4" inputmode="numeric">
              </div>

              <div class="col-12 col-md-6">
                <label class="form-label">Nombre del cliente *</label>
                <input type="text" class="form-control" name="nombre_cliente" id="nombre_editar" required maxlength="200">
              </div>

              <div class="col-12 col-md-6">
                <label class="form-label">Correo del cliente</label>
                <input type="email" class="form-control" name="correo_cliente" id="correo_editar">
              </div>

              <div class="col-6 col-md-4">
                <label class="form-label">Preportabilidad</label>
                <select class="form-select" name="preportabilidad" id="pre_editar">
                  <option value="1">Sí</option>
                  <option value="0">No</option>
                </select>
              </div>

              <div class="col-6 col-md-4">
                <label class="form-label">Tipo</label>
                <select class="form-select" name="tipo_portabilidad" id="tipo_editar">
                  <option value="1">Prepago</option>
                  <option value="2">Pospago</option>
                </select>
              </div>

              <div class="col-12 col-md-4">
                <label class="form-label">Origen</label>
                <select class="form-select" name="origen_porta" id="origen_editar">
                  <option value="1">Web</option>
                  <option value="2">CSV</option>
                  <option value="3">API</option>
                </select>
              </div>
            </div>

            <div class="text-center mt-3">
              <div class="spinner-border text-warning" role="status" style="display:none;">
                <span class="visually-hidden">Procesando...</span>
              </div>
            </div>
          </div>

          <div class="card-footer d-flex justify-content-end gap-2">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            <button type="submit" class="btn btn-warning" id="btn_guardar_editar">
              <i class="bi bi-save me-1"></i> Guardar cambios
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- ======= Modal: SUBIR CSV/TXT ======= -->
<div class="modal fade" id="modal-carga" tabindex="-1" aria-labelledby="cargaModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered mx-auto">
    <div class="modal-content border-0 shadow">
      <form id="frm_csv" method="post" class="m-0" enctype="multipart/form-data" autocomplete="off">
        <div class="card card-info card-outline mb-0">
          <div class="card-header">
            <h5 class="card-title mb-0" id="cargaModalLabel">
              <i class="bi bi-file-earmark-arrow-up me-1"></i> Subir CSV o TXT
            </h5>
            <button type="button" class="btn btn-sm btn-outline-secondary float-end" data-bs-dismiss="modal">Cerrar</button>
          </div>

          <div class="card-body">
            <input type="hidden" name="csrf_token" value="<?php echo Session::get('tokencsrf'); ?>">
            <p class="mb-2">Encabezados requeridos:</p>
            <ul class="small mb-3">
              <li><code>icc</code>, <code>nombre_cliente</code>, <code>correo_cliente</code>, <code>numero_a_portar</code>, <code>nip</code></li>
            </ul>

            <div class="mb-3">
              <label class="form-label">Archivo (.csv o .txt) *</label>
              <input type="file" name="csv" class="form-control" accept=".csv,.txt" required>
              <div class="form-text text-muted">UTF-8 • separador coma (,) • máx 10MB</div>
            </div>

            <div class="progress d-none" id="csv_progress_wrap" style="height:10px;">
              <div id="csv_progress" class="progress-bar" role="progressbar" style="width:0%"></div>
            </div>

            <div id="csv_resumen" class="mt-3 d-none">
              <div class="alert alert-secondary small mb-0">
                <strong>Resumen:</strong>
                <span data-field="ok">0</span> OK,
                <span data-field="skip">0</span> saltos,
                <span data-field="err">0</span> errores.
              </div>
            </div>
          </div>

          <div class="card-footer d-flex justify-content-end gap-2">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            <button type="submit" class="btn btn-info">
              <i class="bi bi-upload me-1"></i> Subir
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>